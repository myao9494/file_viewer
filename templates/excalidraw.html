{% extends "base.html" %}

{% block head %}
<!-- <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@excalidraw/excalidraw@0.17.3/dist/excalidraw.production.min.js"></script> -->
<!-- <script src="{{ url_for('static', filename='js/react.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/react-dom.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/excalidraw.production.min.js') }}"></script> -->
<!-- アセットファイルのパスをローカルに変更 -->
<script src="{{ url_for('static', filename='js/react.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/react-dom.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/excalidraw.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/excalidraw-assets/vendor-677e88ca78c86bddf13d.js') }}"></script>
<!-- 他の必要なアセットファイルも同様に -->

<!-- ントの読み込みの残す -->
<link rel="preload" href="{{ url_for('static', filename='fonts/Virgil.woff2') }}" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="{{ url_for('static', filename='fonts/Cascadia.woff2') }}" as="font" type="font/woff2" crossorigin>

<style>
    .excalidraw-wrapper {
        height: calc(100vh - 50px);
        margin-top: 10px;
    }
    #excalidraw-container {
        height: 100%;
    }
    @font-face {
        font-family: "Virgil";
        src: url("{{ url_for('static', filename='fonts/Virgil.woff2') }}") format("woff2");
        font-display: swap;
    }
    @font-face {
        font-family: "Cascadia";
        src: url("{{ url_for('static', filename='fonts/Cascadia.woff2') }}") format("woff2");
        font-display: swap;
    }
</style>
{% endblock %}

{% block folder_path %}
<div class="folder-path">
    <span title="{{ full_path }}">{{ full_path }}</span>
</div>
{% endblock %}

{% block content %}
<div class="excalidraw-wrapper">
    <button id="add-sticky-note" style="position: fixed; top: 10px; right: 20px; z-index: 1000; padding: 8px;">付箋を追加</button>
    <div id="excalidraw-container"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // ライブラリファイルを読み込む関数を追加
        async function loadExcalidrawLibrary() {
            try {
                const response = await fetch("{{ url_for('static', filename='excalidraw_lib/my_lib.excalidrawlib') }}");
                if (!response.ok) {
                    throw new Error('ライブラリの読み込みに失敗しました');
                }
                return await response.json();
            } catch (error) {
                console.error('ライブラリの読み込みエラー:', error);
                return null;
            }
        }

        // フォーカスを設定してからクリップボードにコピー
        window.focus();
        setTimeout(async () => {
            try {
                const originalPath = '{{ full_path }}';
                // OSを判定（Windows判定）
                const isWindows = navigator.platform.toLowerCase().includes('win');
                
                // パスの変換
                const pathToCopy = isWindows 
                    ? originalPath.replace(/\//g, '\\') // Windowsの場合、スラッシュをバックスラッシュに変換
                    : originalPath; // その他のOSはそのまま
                
                await navigator.clipboard.writeText(pathToCopy);
                console.log('パスをクリップボードにコピーしました:', pathToCopy);
            } catch (err) {
                console.error('クリップボードへのコピーに失敗しました:', err);
            }
        }, 500);

        // Excalidrawの初期化
        const App = () => {
            const [excalidrawAPI, setExcalidrawAPI] = React.useState(null);
            const [elements, setElements] = React.useState([]);
            const [files, setFiles] = React.useState({});

            // ライブラリを読み込むeffectを追加
            React.useEffect(() => {
                if (!excalidrawAPI) return;

                loadExcalidrawLibrary().then(libraryItems => {
                    if (libraryItems) {
                        excalidrawAPI.updateLibrary({
                            libraryItems: libraryItems.libraryItems || []
                        });
                        console.log('ライブラリを読み込みました');
                    }
                });
            }, [excalidrawAPI]);

            // キーボードショートカットのイベントハンドラを追加
            React.useEffect(() => {
                if (!excalidrawAPI) return;

                let mouseX = 0;
                let mouseY = 0;

                const handleMouseMove = (event) => {
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                };

                const handleKeyPress = (event) => {
                    if (event.key.toLowerCase() === 'n' && 
                        !event.target.matches('input, textarea, [contenteditable]')) {
                        event.preventDefault();
                        
                        const viewportPosition = {
                            x: mouseX + excalidrawAPI.getAppState().scrollX,
                            y: mouseY + excalidrawAPI.getAppState().scrollY
                        };

                        // 付箋の追加処理
                        const newElement = {
                            id: Math.random().toString(36).substr(2, 9),
                            type: 'rectangle',
                            x: viewportPosition.x - 100,
                            y: viewportPosition.y - 50,
                            width: 200,
                            height: 100,
                            angle: 0,
                            strokeColor: '#000000',
                            backgroundColor: '#fef3bd',
                            fillStyle: 'solid',
                            strokeWidth: 1,
                            strokeStyle: 'solid',
                            roughness: 0,
                            opacity: 100,
                            groupIds: [],
                            seed: Math.random(),
                            version: 1,
                            versionNonce: 0,
                            isDeleted: false,
                            boundElements: null,
                            updated: Date.now(),
                            link: null,
                            locked: false,
                        };
                        
                        excalidrawAPI.updateScene({
                            elements: [...excalidrawAPI.getSceneElements(), newElement]
                        });
                    }
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('keydown', handleKeyPress);
                
                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('keydown', handleKeyPress);
                };
            }, [excalidrawAPI]);

            // シーンが変更されたときの処理
            const onChange = React.useCallback((newElements, _, newFiles) => {
                setElements(newElements);
                setFiles(newFiles);
            }, []);

            // ライブラリの変更を監視
            const onLibraryChange = React.useCallback(async (libraryItems) => {
                try {
                    const libraryData = {
                        type: "excalidrawlib",
                        version: 2,
                        libraryItems
                    };

                    const response = await fetch("{{ url_for('save_library') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(libraryData)
                    });

                    if (!response.ok) {
                        throw new Error('ライブラリの保存に失敗しました');
                    }
                    console.log('ライブラリを保存しました');
                } catch (error) {
                    console.error('ライブラリの保存エラー:', error);
                }
            }, []);

            // Excalidrawコンポーネントの初期化時に呼ばれるコールバック
            const onMountCallback = React.useCallback((api) => {
                console.log('Excalidraw mounted:', api);
                setExcalidrawAPI(api);
            }, []);

            console.log('Rendering Excalidraw component');

            // Excalidrawコンポーネントをレンダリング
            return React.createElement(ExcalidrawLib.Excalidraw, {
                initialData: {
                    elements: elements,
                    files: files,
                    appState: {
                        viewBackgroundColor: '#ffffff'
                    }
                },
                langCode: 'ja-JP',
                onChange: onChange,
                onMount: onMountCallback,
                onLibraryChange: onLibraryChange,
                excalidrawAPI: (api) => {
                    setExcalidrawAPI(api);
                }
            });
        };

        // アプリケーションのマウント
        try {
            const excalidrawContainer = document.getElementById('excalidraw-container');
            if (!excalidrawContainer) {
                throw new Error('Excalidrawコンテナが見つかりません');
            }

            const root = ReactDOM.createRoot(excalidrawContainer);
            root.render(React.createElement(App));
            console.log('Excalidraw app rendered');
        } catch (error) {
            console.error('Excalidrawの初期化に失敗:', error);
        }
    });
</script>
{% endblock %}
