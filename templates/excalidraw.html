{% extends "base.html" %}

{% block head %}
<!-- <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@excalidraw/excalidraw@0.17.3/dist/excalidraw.production.min.js"></script> -->
<!-- <script src="{{ url_for('static', filename='js/react.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/react-dom.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/excalidraw.production.min.js') }}"></script> -->
<!-- アセットファイルのパスをローカルに変更 -->
<script src="{{ url_for('static', filename='js/react.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/react-dom.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/excalidraw.production.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/excalidraw-assets/vendor-677e88ca78c86bddf13d.js') }}"></script>
<!-- 他の必要なアセットファイルも同様に -->

<!-- ントの読み込みの残す -->
<link rel="preload" href="{{ url_for('static', filename='fonts/Virgil.woff2') }}" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="{{ url_for('static', filename='fonts/Cascadia.woff2') }}" as="font" type="font/woff2" crossorigin>

<style>
    .excalidraw-wrapper {
        height: calc(100vh - 50px);
        margin-top: 10px;
    }
    #excalidraw-container {
        height: 100%;
    }
    @font-face {
        font-family: "Virgil";
        src: url("{{ url_for('static', filename='fonts/Virgil.woff2') }}") format("woff2");
        font-display: swap;
    }
    @font-face {
        font-family: "Cascadia";
        src: url("{{ url_for('static', filename='fonts/Cascadia.woff2') }}") format("woff2");
        font-display: swap;
    }
</style>
{% endblock %}

{% block folder_path %}
<div class="folder-path">
    <span title="{{ full_path }}">{{ full_path }}</span>
</div>
{% endblock %}

{% block content %}
<div class="excalidraw-wrapper">
    <button id="add-sticky-note" style="position: fixed; top: 10px; right: 20px; z-index: 1000; padding: 8px;">付箋を追加</button>
    <div id="excalidraw-container"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // フォーカスを設定してからクリップボードにコピー
        window.focus();
        setTimeout(async () => {
            try {
                const originalPath = '{{ full_path }}';
                // OSを判定（Windows判定）
                const isWindows = navigator.platform.toLowerCase().includes('win');
                
                // パスの変換
                const pathToCopy = isWindows 
                    ? originalPath.replace(/\//g, '\\') // Windowsの場合、スラッシュをバックスラッシュに変換
                    : originalPath; // その他のOSはそのまま
                
                await navigator.clipboard.writeText(pathToCopy);
                console.log('パスをクリップボードにコピーしました:', pathToCopy);
            } catch (err) {
                console.error('クリップボードへのコピーに失敗しました:', err);
            }
        }, 500);

        // Excalidrawの初期化
        const App = () => {
            const [excalidrawAPI, setExcalidrawAPI] = React.useState(null);
            const [elements, setElements] = React.useState([]);
            
            // 付箋を追加する関数
            const addStickyNote = React.useCallback(() => {
                console.log('ボタンがクリックされました');
                console.log('excalidrawAPI:', excalidrawAPI);
                
                if (!excalidrawAPI) {
                    console.warn('Excalidraw API not ready');
                    return;
                }
                
                try {
                    const newElement = {
                        id: Math.random().toString(36).substr(2, 9),
                        type: 'rectangle',
                        x: 100,
                        y: 100,
                        width: 200,
                        height: 100,
                        angle: 0,
                        strokeColor: '#000000',
                        backgroundColor: '#fef3bd',
                        fillStyle: 'solid',
                        strokeWidth: 1,
                        strokeStyle: 'solid',
                        roughness: 0,
                        opacity: 100,
                        groupIds: [],
                        seed: Math.random(),
                        version: 1,
                        versionNonce: 0,
                        isDeleted: false,
                        boundElements: null,
                        updated: Date.now(),
                        link: null,
                        locked: false,
                    };
                    
                    excalidrawAPI.updateScene({
                        elements: [...excalidrawAPI.getSceneElements(), newElement]
                    });
                    console.log('付箋を追加しました:', newElement);
                } catch (error) {
                    console.error('付箋の追加に失敗しました:', error);
                }
            }, [excalidrawAPI]);

            // ボタンのイベントリスナーを設定
            React.useEffect(() => {
                if (!excalidrawAPI) return;

                const button = document.getElementById('add-sticky-note');
                if (button) {
                    button.addEventListener('click', addStickyNote);
                    console.log('ボタンのイベントリスナーを設定しました');
                }

                return () => {
                    const button = document.getElementById('add-sticky-note');
                    if (button) {
                        button.removeEventListener('click', addStickyNote);
                    }
                };
            }, [excalidrawAPI, addStickyNote]);

            // Excalidrawコンポーネントの初期化時に呼ばれるコールバック
            const onMountCallback = React.useCallback((api) => {
                console.log('Excalidraw mounted:', api);
                setExcalidrawAPI(api);
            }, []);

            console.log('Rendering Excalidraw component');

            // Excalidrawコンポーネントをレンダリング
            return React.createElement(ExcalidrawLib.Excalidraw, {
                initialData: {
                    elements: elements,
                    appState: {
                        viewBackgroundColor: '#ffffff'
                    }
                },
                langCode: 'ja-JP',
                onChange: (elements) => {
                    // console.log('Scene changed:', elements);
                    setElements(elements);
                },
                onMount: onMountCallback,
                excalidrawAPI: (api) => {
                    // console.log('Excalidraw API available:', api);
                    setExcalidrawAPI(api);
                }
            });
        };

        // アプリケーションのマウント
        try {
            const excalidrawContainer = document.getElementById('excalidraw-container');
            if (!excalidrawContainer) {
                throw new Error('Excalidrawコンテナが見つかりません');
            }

            const root = ReactDOM.createRoot(excalidrawContainer);
            root.render(React.createElement(App));
            console.log('Excalidraw app rendered');
        } catch (error) {
            console.error('Excalidrawの初期化に失敗:', error);
        }
    });
</script>
{% endblock %}
